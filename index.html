<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotizador de Servicios</title>
</head>
<body>

    <!-- Contenedor de servicios -->
    <div id="contenedor-servicios">
        <!-- Ejemplo de servicios -->

        <div class="servicio" data-precio="400" data-promocion="true">
            <h3>Fotografía de Producto Conceptual (mínimo 5)</h3>
            <p>$400.00/foto</p>
            <select class="cantidad">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">Otra cantidad</option>
            </select>
            <input type="number" class="input-cantidad" style="width: 50px; display: none;" min="0" max="99">
        </div>
        
        <div class="servicio" data-precio="1500" data-promocion="false">
            <h3>Servicio de Diseño Gráfico Premium</h3>
            <p>$1500.00/servicio</p>
            <select class="cantidad">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">Otra cantidad</option>
            </select>
            <input type="number" class="input-cantidad" style="width: 50px; display: none;" min="0" max="99">
        </div>
        
    </div>
    
    <div id="resumen-compra" style="display:none;"></div>

    <div id="botones">
        <button id="continuar">Continuar</button>
        <button id="reiniciar">Reiniciar</button>
    </div>
    
    <div id="botones-resumen" style="display:none;">
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const botonContinuar = document.getElementById('continuar');
            const botonReiniciar = document.getElementById('reiniciar');
            const contenedorServicios = document.getElementById('contenedor-servicios');
            const resumenCompra = document.getElementById('resumen-compra');
            const botonesResumen = document.getElementById('botones-resumen');
            const servicios = document.querySelectorAll('.servicio');
    
            servicios.forEach((servicio, index) => {
                const servicioId = 'servicio_' + index;
                const select = servicio.querySelector('.cantidad');
                let input = servicio.querySelector('.input-cantidad');
    
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.classList.add('input-cantidad');
                    input.style.width = '50px';
                    input.style.display = 'none';
                    input.min = 0;
                    input.max = 99;
                    servicio.appendChild(input);
                }
    
                select.addEventListener('change', () => {
                    if (select.value === '21') {
                        input.style.display = 'inline-block';
                        input.focus();
                    } else {
                        input.style.display = 'none';
                    }
                    localStorage.setItem(servicioId, select.value);
                });
    
                input.addEventListener('blur', () => {
                    const num = parseInt(input.value);
                    if (!isNaN(num) && num >= 0 && num <= 99) {
                        const existsInSelect = Array.from(select.options).some(option => parseInt(option.value) === num);
                        if (existsInSelect && num !== 21) { // Asegurarse de que el número no sea 21
                            select.value = num.toString();  // Selecciona el valor en el select
                            input.style.display = 'none';   // Oculta el campo de texto
                        } else if (num === 21) {
                            select.value = '21'; // Asegura que 21 se maneje correctamente
                            input.style.display = 'inline-block'; // Mantiene visible el campo de texto
                        }
                        localStorage.setItem(servicioId + '_custom', input.value);
                    }
                });
    
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
    
                // Cargar valores guardados
                const valorGuardado = localStorage.getItem(servicioId);
                const valorGuardadoCustom = localStorage.getItem(servicioId + '_custom');
                if (valorGuardado) {
                    select.value = valorGuardado;
                    if (valorGuardado === '21' && valorGuardadoCustom) {
                        input.style.display = 'inline-block';
                        input.value = valorGuardadoCustom;
                    }
                }
            });
    
            function guardarSelecciones() {
                servicios.forEach((servicio, index) => {
                    const servicioId = 'servicio_' + index;
                    const select = servicio.querySelector('.cantidad');
                    const input = servicio.querySelector('.input-cantidad');
                    localStorage.setItem(servicioId, select.value);
                    if (select.value === '21') {
                        localStorage.setItem(servicioId + '_custom', input.value);
                    }
                });
            }
    
            function cargarSelecciones() {
                servicios.forEach((servicio, index) => {
                    const servicioId = 'servicio_' + index;
                    const select = servicio.querySelector('.cantidad');
                    const input = servicio.querySelector('.input-cantidad');
                    const valorGuardado = localStorage.getItem(servicioId);
                    const valorPersonalizado = localStorage.getItem(servicioId + '_custom');
    
                    if (valorGuardado) {
                        select.value = valorGuardado;
                        if (valorGuardado === '21' && valorPersonalizado) {
                            input.style.display = 'inline-block';
                            input.value = valorPersonalizado;
                        } else {
                            input.style.display = 'none';
                        }
                    }
                });
            }
    
            botonContinuar.addEventListener('click', () => {
                guardarSelecciones();
                localStorage.setItem('estadoPagina', 'resumen');
                calcularResumen();
            });
    
            botonReiniciar.addEventListener('click', () => {
                const confirmado = confirm("Esto reiniciará el cotizador, borrando todas las selecciones actuales. ¿Deseas continuar?");
                if (confirmado) {
                    localStorage.clear();
                    location.reload();
                }
            });
    
            const estadoPagina = localStorage.getItem('estadoPagina');
            if (estadoPagina === 'resumen') {
                mostrarResumen();
            } else {
                cargarSelecciones();
            }
    
            function calcularResumen() {
                let total = 0;
                let resumenHtml = "<h2>Resumen de Compra</h2>";
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'decimal',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });
    
                servicios.forEach(servicio => {
                    const select = servicio.querySelector('.cantidad');
                    const input = servicio.querySelector('.input-cantidad');
                    let cantidad = select.value === '21' ? (input && input.style.display !== 'none' ? parseInt(input.value) || 0 : 0) : parseInt(select.value);
                    const precio = parseInt(servicio.dataset.precio);
                    const nombre = servicio.querySelector('h3').textContent;
                    const tienePromocion = servicio.dataset.promocion === "true";
    
                    let subtotal = 0;
                    if (cantidad > 0) {
                        if (tienePromocion && cantidad > 10) {
                            const cantidadSinDescuento = 10;
                            const cantidadConDescuento = cantidad - 10;
                            const precioConDescuento = precio * 0.7;
                            subtotal = (cantidadSinDescuento * precio) + (cantidadConDescuento * precioConDescuento);
                            resumenHtml += `<p>${nombre} (${formatter.format(precio)} por unidad) x ${cantidadSinDescuento} = ${formatter.format(cantidadSinDescuento * precio)}</p>`;
                            resumenHtml += `<p>${nombre} (${formatter.format(precioConDescuento)} por unidad con descuento) x ${cantidadConDescuento} = ${formatter.format(cantidadConDescuento * precioConDescuento)}</p>`;
                        } else {
                            subtotal = cantidad * precio;
                            resumenHtml += `<p>${nombre} (${formatter.format(precio)} por unidad) x ${cantidad} = ${formatter.format(subtotal)}</p>`;
                        }
                        total += subtotal;
                    }
                });
    
                const iva = total * 0.16;
                const totalConIVA = total + iva;
    
                resumenHtml += `<h3>Total: ${formatter.format(total)}</h3>`;
                resumenHtml += `<p>IVA (16%): ${formatter.format(iva)}</p>`;
                resumenHtml += `<h3>Total con IVA: ${formatter.format(totalConIVA)}</h3>`;
    
                localStorage.setItem('resumenHtml', resumenHtml);
    
                resumenCompra.innerHTML = resumenHtml;
                contenedorServicios.style.display = 'none';
                botonContinuar.style.display = 'none';
                resumenCompra.style.display = 'block';
    
                botonesResumen.innerHTML = '<button id="volver">Atrás</button>';
                const volverBtn = document.getElementById('volver');
                volverBtn.addEventListener('click', () => {
                    localStorage.removeItem('estadoPagina');
                    location.reload();
                });
    
                botonesResumen.appendChild(botonReiniciar);
                botonesResumen.style.display = 'block';
            }
    
            function mostrarResumen() {
                const resumenHtml = localStorage.getItem('resumenHtml');
                resumenCompra.innerHTML = resumenHtml || "<p>No hay datos de resumen disponibles.</p>";
                contenedorServicios.style.display = 'none';
                botonContinuar.style.display = 'none';
                resumenCompra.style.display = 'block';
                botonesResumen.innerHTML = '<button id="volver">Atrás</button>';
                const volverBtn = document.getElementById('volver');
                volverBtn.addEventListener('click', () => {
                    localStorage.removeItem('estadoPagina');
                    location.reload();
                });
                botonesResumen.appendChild(botonReiniciar);
                botonesResumen.style.display = 'block';
            }
        });
    </script>
</body>
</html>
